# AGENTS.md

Configuration for autonomous coding agents (e.g., Google Jules, GitHub Copilot) working on the `projr` R package.

---

## Core Philosophy / Project Context

`projr` is an R package that facilitates reproducible and archived research projects. Its primary goal is to automate the full lifecycle of a research build: rendering documents, bumping versions, committing to Git, and archiving outputs to remote destinations (GitHub Releases, OSF, or local directories).

Key architectural patterns:

- **Single build entry point**: `projr_build_patch/minor/major()` for production; `projr_build_dev()` for development.
- **YAML-driven configuration**: All project settings live in `_projr.yml` at the project root.
- **Manifest tracking**: Every build records file hashes in `manifest.csv`, linking outputs to exact input versions.
- **Remote destinations**: A unified dispatcher pattern (`R/remote.R`) routes file operations to local, GitHub, or OSF backends.
- **Internal vs. exported functions**: Internal helpers use a `.` prefix (e.g., `.hash_file()`); exported functions use the `projr_` prefix (e.g., `projr_build_patch()`).

---

## Tech Stack & Tooling

### Language

- **R** (≥ 4.1.0) — all source code lives in `R/`

### Core R package dependencies (Imports)

| Package | Purpose |
|---------|---------|
| `renv` | Reproducible dependency management |
| `yaml` | Read/write `_projr.yml` |
| `jsonlite` | JSON serialisation |
| `rprojroot` | Reliable project-root detection |
| `desc` | Read/write `DESCRIPTION` |
| `fs` | File-system operations |
| `digest` | MD5 hashing for manifests |
| `cli` | Console output |
| `glue` | String interpolation |

### Suggested / optional dependencies

`gert`, `gh`, `gitcreds`, `credentials` (Git/GitHub), `httr` (GitHub Releases API), `osfr` (OSF), `rmarkdown`, `quarto`, `bookdown`, `knitr` (document rendering), `testthat` ≥ 3.0 (testing), `devtools`, `usethis`, `styler`, `roxygen2` (development).

### What NOT to use

- **Do not use `piggyback`** for GitHub Release operations — all GitHub API calls go through `httr` directly (see `R/remote-github-httr.R`).
- **Do not use the `magrittr` pipe (`%>%`)** — use the native R pipe `|>` instead.
- **Do not edit files in `man/`** — they are auto-generated by `roxygen2`.

### Document rendering

- Quarto (`quarto-dev/quarto-actions`)
- R Markdown / Bookdown

---

## Setup Commands

Run these commands once to configure a local development environment.

### 1. Install system dependencies (Ubuntu / Debian)

```bash
sudo apt-get update -y
sudo apt-get install --no-install-recommends -y \
  libcurl4-openssl-dev libfontconfig1-dev libfreetype6-dev \
  libgit2-dev libjpeg-dev libpng-dev libx11-dev pandoc
```

### 2. Install Quarto

Follow the instructions at <https://quarto.org/docs/get-started/> or use:

```bash
# Via quarto-dev/quarto-actions (CI)
# Locally: download installer from https://quarto.org
```

### 3. Restore R dependencies with renv

```r
# Inside an R session at the project root:
renv::restore()
```

### 4. Load the package for interactive development

```r
devtools::load_all()
```

---

## Build & Test Instructions

### Run the test suite (LITE mode — recommended for development)

```r
devtools::load_all()
.test_set_lite()
devtools::test()
```

LITE mode runs ~364 core tests in ~2.5 minutes. It must be explicitly enabled with `.test_set_lite()` before each session; without it, `devtools::test()` runs the full suite.

### Run the full test suite

```r
devtools::load_all()
devtools::test()
```

Full mode runs ~452 tests and is used for pre-release validation.

### Debug a specific test

```r
devtools::load_all()
.test_unset_lite()   # Disable LITE mode so the target test runs
.test_set_select()   # Skip all other tests

# Temporarily comment out skip_if(.is_test_select()) in the target test file
devtools::test()

# Restore when done:
.test_unset_select()
```

### R CMD check

```r
devtools::check()
```

### Lint / format code

```r
styler::style_pkg()
```

### Update documentation

```r
devtools::document()   # Regenerates man/ and NAMESPACE from roxygen2 comments
```

### Verify pkgdown reference index

```r
pkgdown::check_pkgdown()
```

---

## Coding Style & Conventions

### Naming

- **Exported functions**: `projr_` prefix, `snake_case` (e.g., `projr_build_patch()`).
- **Internal functions**: `.` prefix, `snake_case` (e.g., `.hash_file()`).
- **Variables**: descriptive `snake_case`; avoid single-letter or highly abbreviated names.
- **Temporal pairs**: prefer `before`/`after`, `previous`/`current`, `old`/`new` over generic `_pre`/`_post` suffixes.
- **File paths**: use `filename` (name only) or `filepath` (full path); use plural (`filenames`, `filepaths`) for vectors.

### Code style

- Indent with **2 spaces**.
- Use the **native pipe** `|>`, not `%>%`.
- Keep functions focused and modular.
- Validate all inputs at the top of functions using `.assert_*()` helpers from `R/check.R`.

### Documentation (roxygen2)

All **exported** functions must include:

```r
#' @title Short title
#' @description Detailed description.
#' @param x character. Description of x.
#' @return Describe the return value.
#' @export
#' @examples
#' \dontrun{
#'   projr_example()
#' }
```

Internal functions (`.` prefix) must **not** have `@export`.

### Logging

- Use `.cli_debug()`, `.cli_info()`, `.cli_success()`, `.cli_step()` — they automatically read the `PROJR_OUTPUT_LEVEL` environment variable.
- Do **not** pass `output_level` as a function parameter.
- Do **not** log inside tight loops over many files; log summaries instead.

### Tests

- Framework: `testthat` edition 3 (`Config/testthat/edition: 3` in `DESCRIPTION`).
- Test files: `tests/testthat/test-{feature}.R`.
- Helper functions: `tests/testthat/helper-*.R` (not in `R/`).
- Add `skip_if(.is_test_select())` to every test to enable selective debugging.
- Add `skip_if(.is_test_lite())` to comprehensive / exhaustive-parameter tests.
- Add `skip_if(.is_test_cran())` to any test that is slow or hits the network.
- Wrap tests that need a temporary project in `usethis::with_project()`.

### Commits / PRs

- Make **minimal, surgical changes** — change as few lines as possible.
- Run `devtools::document()`, `devtools::test()` (LITE), and `styler::style_pkg()` before committing.
- Update `_pkgdown.yml` when adding or removing exported functions, then verify with `pkgdown::check_pkgdown()`.
- Ensure files end with a **single newline** and have **no trailing whitespace**.
- Never leave `browser()` or unguarded interactive debugging calls in committed code.

### Environment variables

| Variable | Values | Purpose |
|----------|--------|---------|
| `PROJR_OUTPUT_LEVEL` | `none` / `std` / `debug` | Console verbosity |
| `PROJR_CLEAR_OUTPUT` | `pre` / `post` / `never` | When to clear output dirs |
| `PROJR_LOG_DETAILED` | `TRUE` / `FALSE` | Create detailed log files |
| `R_PKG_TEST_LITE` | set / unset | Enable LITE test mode |
| `R_PKG_TEST_CRAN` | set / unset | Enable CRAN test mode |
| `R_PKG_TEST_SELECT` | set / unset | Enable SELECT test mode |
| `GITHUB_PAT` | token | GitHub authentication (highest priority) |
| `OSF_PAT` | token | OSF authentication |
